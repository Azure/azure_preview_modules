- name: Fix resource prefix
  set_fact:
    role_name: "{{ (resource_group | replace('-','x'))[-8:] }}{{ 1000 | random }}testrole"
    subscription_id: "{{ lookup('env','AZURE_SUBSCRIPTION_ID') }}"
  run_once: yes

- name: Create a role definition (Check Mode)
  azure_rm_roledefinition:
    name: "{{ role_name }}"
    scope: "/subscriptions/{{ subscription_id }}/resourceGroups/myresourceGroup"
    permissions:
      actions:
        - "Microsoft.Compute/read"
        - "Microsoft.Storage/read"
      data_actions:
        - "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write"
    assignable_scopes:
        - "/subscriptions/{{ subscription_id }}"
  check_mode: yes
  register: output

- name: Assert creating role definition check mode
  assert:
    that:
      - output.changed

- name: Create a role definition
  azure_rm_roledefinition:
    name: "{{ role_name }}"
    scope: "/subscriptions/{{ subscription_id }}/resourceGroups/myresourceGroup"
    permissions:
      actions:
        - "Microsoft.Compute/read"
        - "Microsoft.Storage/read"
      data_actions:
        - "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write"
    assignable_scopes:
        - "/subscriptions/{{ subscription_id }}"
  register: output

- name: Assert creating role definition
  assert:
    that:
      - output.changed

- name: Update the role definition (idempotent)
  azure_rm_roledefinition:
    name: "{{ role_name }}"
    scope: "/subscriptions/{{ subscription_id }}/resourceGroups/myresourceGroup"
    permissions:
      actions:
        - "Microsoft.Compute/read"
        - "Microsoft.Storage/read"
      data_actions:
        - "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write"
    assignable_scopes:
        - "/subscriptions/{{ subscription_id }}"
  register: output

- name: assert output not changed
  assert:
    that:
      - not output.changed

- name: Update the role definition
  azure_rm_roledefinition:
    name: "{{ role_name }}"
    scope: "/subscriptions/{{ subscription_id }}/resourceGroups/myresourceGroup"
    permissions:
      actions:
        - "Microsoft.Compute/read"
        - "Microsoft.Compute/virtualMachines/start/action"
        - "Microsoft.Storage/read"
        - "Microsoft.Network/read"
      data_actions:
        - "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/*"
    assignable_scopes:
        - "/subscriptions/{{ subscription_id }}"
  register: output

- name: assert output changed
  assert:
    that:
      - output.changed

- name: Delete the role definition (Check Mode)
  azure_rm_roledefinition:
    name: "{{ role_name }}"
    scope: "/subscriptions/{{ subscription_id }}/resourceGroups/myresourceGroup"
  check_mode: yes
  register: output

- name: assert deleting role definition check mode
  assert:
    that: output.changed

- name: Delete the redis cache
  azure_rm_roledefinition:
    name: "{{ role_name }}"
    scope: "/subscriptions/{{ subscription_id }}/resourceGroups/myresourceGroup"
  register: output

- assert:
    that:
      - output.changed