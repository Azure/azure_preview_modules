- name: Prepare random number
  set_fact:
    rpfx: "{{ resource_group | hash('md5') | truncate(7, True, '') }}{{ 1000 | random }}"
  run_once: yes

- name: Create instance of Lab -- check mode
  azure_rm_devtestlabslab:
    resource_group: "{{ resource_group }}"
    name: "lab{{ rpfx }}"
    location: eastus
    lab_storage_type: standard
    premium_data_disks: no
  check_mode: yes
  register: output
- name: Assert the resource instance is well created
  assert:
    that:
      - output.changed

- name: Create instance of Lab
  azure_rm_devtestlabslab:
    resource_group: "{{ resource_group }}"
    name: "lab{{ rpfx }}"
    location: eastus
    lab_storage_type: standard
    premium_data_disks: no
  register: output
- name: Assert the resource instance is well created
  assert:
    that:
      - output.changed

- name: Create again instance of Lab
  azure_rm_devtestlabslab:
    resource_group: "{{ resource_group }}"
    name: "lab{{ rpfx }}"
    location: eastus
    lab_storage_type: standard
    premium_data_disks: no
  register: output
- name: Assert the state has not changed
  assert:
    that:
      - output.changed == false


- name: Create instance of dev test labs virtual network
  azure_rm_devtestlabsvirtualnetwork:
    resource_group: "{{ resource_group }}"
    lab_name: "lab{{ rpfx}}"
    name: "vn{{ rpfx }}"
    location: eastus
  register: output_vn

- name: Create instance of dev test labs artifacts source
  azure_rm_devtestlabsartifactsource:
    resource_group: "{{ resource_group }}"
    lab_name: "lab{{ rpfx}}"
    name: "lab{{ rpfx }}"
    display_name: My Artifacts Source
    location: eastus
    uri: https://github.com/testormoo/azure-devtestlab.git
    source_type: github
    folder_path: /Artifacts
    security_token: "5664bfc9f894c965e8ac3c5b5f9b4f663487515a"
  register: artifacts_output

- name: Create instance of dev test labs virtual machine
  azure_rm_devtestlabsvirtualmachine:
    resource_group: "{{ resource_group }}"
    lab_name: "lab{{ rpfx}}"
    name: "vm{{ rpfx }}"
    location: eastus
    notes: Virtual machine notes, just something....
    created_by_user: zikalino@microsoft.com
    os_type: linux
    size: Standard_A2_v2
    user_name: zim
    password: ZSuppas$$21!
    lab_subnet_name: "vn{{ rpfx }}Subnet"
    lab_virtual_network_id: "{{ output_vn.id }}"
    disallow_public_ip_address: yes
    gallery_image_reference:
      offer: UbuntuServer
      publisher: Canonical
      sku: 16.04-LTS
      os_type: Linux
      version: latest
    artifacts:
      - artifact_id: "{{ artifacts_output.id }}/Artifacts/linux-install-mongodb"
    network_interface:
      virtual_network_id: moo
    applicable_schedule:
      location: eastus
      lab_vms_shutdown:
        location: eastus

    allow_claim: no
  register: vm_output
  ignore_errors: yes




- name: Delete instance of Lab -- check mode
  azure_rm_devtestlabslab:
    resource_group: "{{ resource_group }}"
    state: absent
    name: "lab{{ rpfx }}"
  check_mode: yes
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed

- name: Delete instance of Lab
  azure_rm_devtestlabslab:
    resource_group: "{{ resource_group }}"
    name: "lab{{ rpfx }}"
    state: absent
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed

- name: Delete unexisting instance of Lab
  azure_rm_devtestlabslab:
    resource_group: "{{ resource_group }}"
    name: "lab{{ rpfx }}unexisting"
    state: absent
  register: output
- name: Assert the state has changed
  assert:
    that:
      - output.changed == false
